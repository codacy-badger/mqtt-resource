---

#####################################################################################
resources:

# Docker
- name:                         docker-alpine
  type:                         docker-image
  check_every:                  10m
  source:
    repository:                 alpine
    tag:                        3.8

# Others
- name:                         mqtt-broker
  type:                         mqtt
  source:
    url:                        mqttbroker.andrelademann.de
    topic:                       project/alert


#####################################################################################
resource_types:
- name:                         mqtt
  type:                         docker-image
  source:
    repository:                 concourse-resources/mqtt-resource
    tag:                        latest
#####################################################################################
jobs:
- name:                         test
  serial:                       true
  build_logs_to_retain:         10
  plan:
  - aggregate:
    - get:                      docker-alpine
      trigger:                  true
  - task:                       test
    privileged:                 true
    config:
      platform:                 linux
      image_resource:
        type:                   docker-image
        source:
          repository:           netresearch/dcind
      inputs:
        - name:                 docker-alpine
      outputs:
      - name:                   out
        path:                   ""
      run:
        path:                   sh
        args:
        - -exc
        - |
          message header "Initialize docker"
          source /docker-lib.sh
          start_docker

          message header "Load images"
          docker load -i docker-alpine/image
          docker tag "$(cat docker-alpine/image-id)" alpine:latest

          message header "Available images"
          docker images
  on_success:
    put:                        mqtt-broker
    params:
      payload:                  Release success
  on_failure:
    put:                        mqtt-broker
    params:
      topic:                     my/overridden/topic
      payload:                  Release failure
  on_abort:
    put:                        mqtt-broker
    params:
      payload:                  Release aborted
